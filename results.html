<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Results ‚Äî Thread</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="page">
  <header class="site-header">
    <div class="wrap">
      <a href="index.html" class="logo">Thread<span>.</span></a>
      <nav class="nav">
        <a href="index.html">Home</a>
      </nav>
    </div>
  </header>

  <main class="main">
    <section class="results-header">
      <div class="wrap">
        <form class="results-search-form" id="results-search" action="results.html" method="get">
          <span class="icon" aria-hidden="true">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </span>
          <input type="search" name="q" class="search-input" placeholder="Ask an AI research question‚Ä¶" id="query-input" required>
          <input type="hidden" name="mode" id="search-mode" value="student">
          <button type="submit" class="search-btn">Search</button>
        </form>
        <div class="mode-selector" style="margin-top: 0.75rem; justify-content: flex-start;">
          <button class="mode-btn" data-mode="student" id="mode-student">Student</button>
          <button class="mode-btn" data-mode="researcher" id="mode-researcher">Researcher</button>
        </div>
        <div class="query-display-wrap">
          <p class="query-display" id="query-display">Showing results for <strong id="query-bold"></strong></p>
          <div class="mode-badge" id="mode-badge">Student Mode</div>
        </div>
      </div>
    </section>

    <!-- Skills Panel (Sidebar) -->
    <aside class="skills-panel" id="skills-panel">
      <div class="skills-header">
        <h3>Skills</h3>
        <button class="skills-close" id="skills-close">√ó</button>
      </div>
      <div class="skills-content" id="skills-content">
        <div class="skill-loading">Select a skill to use AI assistance...</div>
      </div>
    </aside>

    <section class="section">
      <div class="wrap">
        <div class="section-header-with-skills">
          <h2 class="section-title"><span class="badge">Overview</span> Field snapshot</h2>
          <button class="skills-toggle" id="skills-toggle">Skills</button>
        </div>
        <div class="overview-card" id="overview-card">
          <div class="loading-spinner" id="overview-loading">Generating AI overview...</div>
          <p id="overview-text" style="display: none;">‚Äî</p>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top: 0;">
      <div class="wrap">
        <h2 class="section-title"><span class="badge">Key claims</span> Evidence-backed statements</h2>
        <div class="claims-list" id="claims-list">
          <div class="loading-spinner">Loading claims...</div>
        </div>
      </div>
    </section>

    <section class="section" style="padding-top: 0;">
      <div class="wrap">
        <h2 class="section-title"><span class="badge">Retrieval</span> Knowledge graph</h2>
        <div class="retrieval-shell">
          <div class="retrieval-card">
            <div id="retrieval-status" class="retrieval-status-text">
              Graph will appear after search.
            </div>
            <div class="retrieval-filter">
              <label for="retrieval-filter-year">Filter by year</label>
              <select id="retrieval-filter-year">
                <option value="all">All years</option>
                <option value="2015">Since 2015</option>
                <option value="2018">Since 2018</option>
                <option value="2020">Since 2020</option>
              </select>
            </div>
            <div id="retrieval-graph" class="retrieval-graph"></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <p>Thread ‚Äî AI-powered academic search for AI/ML research.</p>
  </footer>

  <script src="assets/js/ai.js"></script>
  <script src="https://unpkg.com/d3@7.8.5/dist/d3.min.js"></script>
  <script src="assets/js/retrieval-graph.js"></script>
  <script>
    (function() {
      'use strict';
      // Ensure AIService is available
      if (typeof AIService === 'undefined' && typeof window !== 'undefined' && window.AIService) {
        AIService = window.AIService;
      }
      if (typeof AIService === 'undefined') {
        console.error('AIService is not loaded. Please check assets/js/ai.js');
        alert('Error: AI Service failed to load. Please refresh the page.');
        return;
      }
      var params = new URLSearchParams(location.search);
      var q = params.get('q') || 'How do transformers work?';
      var mode = params.get('mode') || 'student';
      var allPapers = [];
      var matchedPapers = [];

      // UI Elements
      var input = document.getElementById('query-input');
      var queryBold = document.getElementById('query-bold');
      var overviewText = document.getElementById('overview-text');
      var overviewLoading = document.getElementById('overview-loading');
      var overviewCard = document.getElementById('overview-card');
      var claimsEl = document.getElementById('claims-list');
      var modeBadge = document.getElementById('mode-badge');
      var searchMode = document.getElementById('search-mode');
      var skillsPanel = document.getElementById('skills-panel');
      var skillsToggle = document.getElementById('skills-toggle');
      var skillsClose = document.getElementById('skills-close');
      var skillsContent = document.getElementById('skills-content');
      var modeBtnStudent = document.getElementById('mode-student');
      var modeBtnResearcher = document.getElementById('mode-researcher');
      var retrievalSimilarities = [];

      // Set UI
      input.value = q;
      queryBold.textContent = q;
      document.title = (q.length > 50 ? q.slice(0, 47) + '‚Ä¶' : q) + ' ‚Äî Thread';
      modeBadge.textContent = mode === 'student' ? 'Student Mode' : 'Researcher Mode';
      searchMode.value = mode;
      // Sync toggle buttons
      if (modeBtnStudent && modeBtnResearcher) {
        if (mode === 'student') {
          modeBtnStudent.classList.add('active');
          modeBtnResearcher.classList.remove('active');
        } else {
          modeBtnResearcher.classList.add('active');
          modeBtnStudent.classList.remove('active');
        }
      }

      function setMode(nextMode) {
        if (nextMode !== 'student' && nextMode !== 'researcher') return;
        mode = nextMode;
        searchMode.value = nextMode;
        modeBadge.textContent = nextMode === 'student' ? 'Student Mode' : 'Researcher Mode';

        if (modeBtnStudent && modeBtnResearcher) {
          if (nextMode === 'student') {
            modeBtnStudent.classList.add('active');
            modeBtnResearcher.classList.remove('active');
          } else {
            modeBtnResearcher.classList.add('active');
            modeBtnStudent.classList.remove('active');
          }
        }

        // Update URL without reloading
        try {
          var url = new URL(location.href);
          url.searchParams.set('mode', nextMode);
          history.replaceState({}, '', url.toString());
        } catch (e) {}

        // Re-render links that embed mode, and refresh skills list
        displayClaims();
        if (skillsPanel.classList.contains('active')) loadSkills();
      }

      if (modeBtnStudent) modeBtnStudent.addEventListener('click', function() { setMode('student'); });
      if (modeBtnResearcher) modeBtnResearcher.addEventListener('click', function() { setMode('researcher'); });

      // Load papers metadata
      fetch('papers/metadata.json')
        .then(res => {
          if (!res.ok) {
            throw new Error('Failed to load metadata.json: ' + res.status);
          }
          return res.json();
        })
        .then(data => {
          if (!data.papers || !Array.isArray(data.papers)) {
            throw new Error('Invalid metadata.json format');
          }
          allPapers = data.papers;
          performSearch();
        })
        .catch(err => {
          console.error('Failed to load papers:', err);
          overviewLoading.textContent = 'Error loading papers: ' + err.message + '. Please check metadata.json exists.';
          claimsEl.innerHTML = '<p style="color: var(--text-muted);">Error loading claims.</p>';
        });

      // Helper function to escape HTML
      function escapeHtml(text) {
        if (!text) return '';
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      async function performSearch() {
        if (!allPapers || allPapers.length === 0) {
          console.error('No papers loaded');
          overviewLoading.textContent = 'No papers available. Please check papers/metadata.json.';
          overviewLoading.style.display = '';
          overviewText.style.display = 'none';
          return;
        }
        
        // Semantic search (AI ranking)
        try {
          overviewLoading.textContent = 'AI is thinking about which papers are most relevant...';
          matchedPapers = await AIService.semanticSearchAI(q, allPapers);
          
          if (!matchedPapers || matchedPapers.length === 0) {
            claimsEl.innerHTML = '<p style="color: var(--text-muted);">No papers found. Try a different query.</p>';
            overviewLoading.textContent = 'No papers found for this query.';
            return;
          }
          
          // Generate AI overview
          generateOverview();
          
          // Extract and display claims
          displayClaims();
          
          // Precompute pairwise similarities for galaxy view
          try {
            if (AIService.computePaperSimilarities) {
              retrievalSimilarities = await AIService.computePaperSimilarities(q, matchedPapers.slice(0, 12));
            }
          } catch (e) {
            retrievalSimilarities = [];
          }
          
          if (typeof initRetrievalGalaxy === 'function') {
            initRetrievalGalaxy();
          }
        } catch (error) {
          console.error('Search error:', error);
          claimsEl.innerHTML = '<p style="color: var(--text-muted);">Error performing search: ' + error.message + '</p>';
        }
      }

      async function generateOverview() {
        if (!matchedPapers || matchedPapers.length === 0) {
          overviewText.textContent = 'No papers found for this query.';
          overviewText.style.display = 'block';
          overviewLoading.style.display = 'none';
          return;
        }
        
        try {
          overviewLoading.textContent = 'Generating AI overview...';
          var snapshot = await AIService.generateFieldSnapshot(q, matchedPapers);
          if (snapshot && snapshot.trim()) {
            overviewText.textContent = snapshot;
          } else {
            throw new Error('Empty response from AI');
          }
          overviewText.style.display = 'block';
          overviewLoading.style.display = 'none';
        } catch (error) {
          console.error('Overview generation failed:', error);
          // Fallback overview
          var paperCount = matchedPapers.length;
          overviewText.textContent = 'Found ' + paperCount + ' relevant paper' + (paperCount > 1 ? 's' : '') + ' related to "' + q + '". Research in this area shows significant developments, with notable contributions to understanding and advancing the field.';
          overviewText.style.display = 'block';
          overviewLoading.style.display = 'none';
        }
      }

      async function displayClaims() {
        claimsEl.innerHTML = '';
        
        if (!matchedPapers || matchedPapers.length === 0) {
          claimsEl.innerHTML = '<p style="color: var(--text-muted);">No papers available to extract claims from.</p>';
          return;
        }

        claimsEl.innerHTML = '<div class="loading-spinner">Generating key claims from question and papers...</div>';
        var indexByPaperId = {};
        var topPapers = matchedPapers.slice(0, 5);
        try {
          var indexPromises = topPapers.map(function(paper) {
            return fetch('papers/' + encodeURIComponent(paper.id) + '_index.json')
              .then(function(res) { return res.ok ? res.json() : null; })
              .catch(function() { return null; })
              .then(function(data) { return { id: paper.id, data: data }; });
          });
          var indexResults = await Promise.all(indexPromises);
          indexResults.forEach(function(r) {
            if (r && r.data) indexByPaperId[r.id] = r.data;
          });
        } catch (e) {
          // continue without indices
        }

        var claimsToShow = [];
        try {
          if (AIService.generateKeyClaimsForQuery) {
            claimsToShow = await AIService.generateKeyClaimsForQuery(q, matchedPapers, indexByPaperId);
          }
        } catch (err) {
          console.error('Key claims generation failed:', err);
        }

        claimsEl.innerHTML = '';
        if (!claimsToShow || claimsToShow.length === 0) {
          claimsEl.innerHTML = '<p style="color: var(--text-muted);">No claims generated. Try a different query or check your API key.</p>';
          return;
        }

        var qEnc = encodeURIComponent(q);
        claimsToShow.forEach(function(c) {
          if (!c.paper || !c.paper.id || !c.paper.authors || !c.paper.authors[0]) return;
          var card = document.createElement('div');
          card.className = 'claim-card';
          var authorName = c.paper.authors[0].split(',')[0];
          var year = c.paper.year || '';
          var shortKey = authorName.replace(/[^A-Za-z0-9]/g, '') + (year || '');
          var refText = authorName + (c.paper.authors.length > 1 ? ' et al.' : '') + (year ? ' (' + year + ')' : '') + '. ' + c.paper.title + '.';
          
          // Check if page exists and is a valid number (handle both number and string)
          var pageNum = null;
          if (c.page != null && c.page !== undefined) {
            if (typeof c.page === 'number') {
              pageNum = c.page;
            } else if (typeof c.page === 'string' && c.page.trim() !== '') {
              var parsed = parseInt(c.page, 10);
              if (!isNaN(parsed)) pageNum = parsed;
            }
          }
          
          // Debug: log claim page value and URL
          console.log('[Key Claims] Claim:', c.claim.substring(0, 50) + '...', 'c.page:', c.page, 'type:', typeof c.page, 'parsed pageNum:', pageNum);
          
          var pageLink = '';
          if (pageNum != null && c.paper.file_path) {
            pageLink = ' <a class="claim-page-link" href="' + escapeHtml(c.paper.file_path) + '#page=' + pageNum + '" target="_blank" rel="noopener">Page ' + pageNum + '</a>';
          }
          
          var paperUrl = 'paper.html?id=' + encodeURIComponent(c.paper.id) + '&q=' + qEnc + '&mode=' + mode;
          if (pageNum != null) {
            paperUrl += '&page=' + pageNum;
            console.log('[Key Claims] Paper URL with page:', paperUrl);
          } else {
            console.log('[Key Claims] Paper URL WITHOUT page (pageNum is null):', paperUrl);
          }
          
          // Add title attribute to show full URL on hover (for debugging)
          var linkTitle = pageNum != null ? 'Click to open paper page with Page ' + pageNum + ' highlighted' : 'Click to open paper page';
          
          card.innerHTML = '<p class="claim-text">' + escapeHtml(c.claim) + '</p>' +
            '<div class="claim-meta">' +
              '<span class="evidence-badge evidence-strong">AI ¬∑ question + papers</span>' +
              '<span>From </span><a class="claim-source" href="' + escapeHtml(paperUrl) + '" title="' + escapeHtml(linkTitle) + '">' + escapeHtml(authorName) + ' et al., ' + c.paper.year + '</a>' +
              (pageNum != null ? ' <span style="font-size:0.8em; color:var(--text-muted);">(click "From" to highlight Page ' + pageNum + ')</span>' : '') +
              pageLink +
              '<button class="claim-add-btn" type="button" data-claim="' + encodeURIComponent(c.claim) + '" data-ref-key="' + encodeURIComponent(shortKey) + '" data-ref-text="' + encodeURIComponent(refText) + '">Add to Draft</button>' +
            '</div>';
          claimsEl.appendChild(card);
        });

        // Wire claim -> draft (stage into Add a snippet box, actual add happens on Add click)
        document.querySelectorAll('.claim-add-btn').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var decoded = '';
            try { decoded = decodeURIComponent(this.dataset.claim || ''); } catch (e) { decoded = this.dataset.claim || ''; }
            var text = (decoded || '').trim();
            if (!text) return;
            var refKey = '';
            var refText = '';
            try { refKey = decodeURIComponent(this.dataset.refKey || ''); } catch (e) { refKey = this.dataset.refKey || ''; }
            try { refText = decodeURIComponent(this.dataset.refText || ''); } catch (e) { refText = this.dataset.refText || ''; }

            // ensure draft exists
            var draft = loadDraft();
            if (!draft) {
              skillsPanel.classList.add('active');
              skillsContent.innerHTML = '<div class="skill-loading">Creating a draft outline...</div>';
              var outlineJson = await AIService.generateDraftOutline(q, matchedPapers);
              draft = defaultDraftFromOutline(outlineJson);
              saveDraft(draft);
            }

            // open draft view and pre-fill snippet box
            skillsPanel.classList.add('active');
            renderDraft(loadDraft());
            draftPendingSource = 'claim';
            var ta = document.getElementById('draft-snippet');
            if (ta) {
              ta.value = text;
              ta.focus();
            }

            // Temporarily stash ref info into dataset of textarea for when user clicks Add
            if (ta) {
              ta.dataset.refKey = refKey || '';
              ta.dataset.refText = refText || '';
            }
          });
        });
      }

      // ===== Retrieval: 2D knowledge graph (Obsidian-style) =====
      var retrievalGraphInstance = null;
      function initRetrievalGalaxy() {
        var statusEl = document.getElementById('retrieval-status');
        var graphEl = document.getElementById('retrieval-graph');
        var filterYearSelect = document.getElementById('retrieval-filter-year');
        if (!statusEl || !graphEl) return;

        if (!matchedPapers || matchedPapers.length === 0) {
          statusEl.textContent = 'No papers to visualize.';
          graphEl.innerHTML = '';
          return;
        }

        statusEl.textContent = 'Drag to pan ¬∑ Scroll to zoom ¬∑ Click a node to open paper.';

        var filterYearValue = (filterYearSelect && filterYearSelect.value) ? filterYearSelect.value : 'all';

        function onOpenPaper(paper) {
          if (!paper) return;
          if (paper.file_path) {
            window.open(paper.file_path, '_blank');
          } else if (paper.id) {
            var qEnc = encodeURIComponent(q);
            window.open('paper.html?id=' + encodeURIComponent(paper.id) + '&q=' + qEnc + '&mode=' + mode, '_blank');
          }
        }

        if (retrievalGraphInstance && retrievalGraphInstance.destroy) {
          retrievalGraphInstance.destroy();
          retrievalGraphInstance = null;
        }

        if (typeof initRetrievalGraph === 'function') {
          retrievalGraphInstance = initRetrievalGraph(graphEl, {
            query: q,
            papers: matchedPapers,
            similarities: retrievalSimilarities || [],
            yearFilter: filterYearValue,
            onOpenPaper: onOpenPaper
          });
        }

        if (filterYearSelect) {
          filterYearSelect.onchange = function() {
            filterYearValue = this.value || 'all';
            if (retrievalGraphInstance && retrievalGraphInstance.destroy) retrievalGraphInstance.destroy();
            retrievalGraphInstance = initRetrievalGraph(graphEl, {
              query: q,
              papers: matchedPapers,
              similarities: retrievalSimilarities || [],
              yearFilter: filterYearValue,
              onOpenPaper: onOpenPaper
            });
          };
        }
      }

      // Skills Panel
      skillsToggle.addEventListener('click', function() {
        skillsPanel.classList.add('active');
        loadSkills();
      });

      skillsClose.addEventListener('click', function() {
        skillsPanel.classList.remove('active');
      });

      function loadSkills() {
        var skills = mode === 'student' ? [
          { name: 'Paper Draft (Write a paper)', id: 'draft', icon: 'üßæ' },
          { name: 'Explain Core Concepts', id: 'explain', icon: 'üí°' },
          { name: 'Compare Papers', id: 'compare', icon: '‚öñÔ∏è' }
        ] : [
          { name: 'Identify Research Gaps', id: 'gaps', icon: 'üîç' },
          { name: 'Track Latest Trends', id: 'trends', icon: 'üìà' },
          { name: 'Compare Papers', id: 'compare', icon: '‚öñÔ∏è' }
        ];

        skillsContent.innerHTML = '<div class="skills-list">' +
          skills.map(s => '<button class="skill-btn" data-skill="' + s.id + '">' + s.icon + ' ' + s.name + '</button>').join('') +
          '</div>';

        document.querySelectorAll('.skill-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            var skillId = this.dataset.skill;
            executeSkill(skillId);
          });
        });
      }

      // ===== Paper Draft (student writing workflow) =====
      function draftStorageKey() {
        // Keep drafts per (mode, query) so user can have multiple drafts
        return 'thread_draft::' + mode + '::' + (q || '').trim().toLowerCase();
      }

      function draftHistoryKey() {
        return draftStorageKey() + '::history';
      }

      // Track where the current snippet comes from: manual | claim | skill
      var draftPendingSource = 'manual';

      function loadDraft() {
        try {
          var raw = localStorage.getItem(draftStorageKey());
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) {
          return null;
        }
      }

      function saveDraft(draft) {
        try {
          draft.updated_at = new Date().toISOString();
          localStorage.setItem(draftStorageKey(), JSON.stringify(draft));

          // history (append snapshots, keep last 20)
          var histRaw = localStorage.getItem(draftHistoryKey());
          var hist = [];
          try { hist = histRaw ? JSON.parse(histRaw) : []; } catch (e) { hist = []; }
          hist.unshift({ at: draft.updated_at, draft: draft });
          hist = hist.slice(0, 20);
          localStorage.setItem(draftHistoryKey(), JSON.stringify(hist));
        } catch (e) {
          // ignore storage errors
        }
      }

      function defaultDraftFromOutline(outlineJson) {
        var sections = (outlineJson && outlineJson.sections) ? outlineJson.sections : [];
        return {
          query: q,
          mode: mode,
          title: (outlineJson && outlineJson.title) ? outlineJson.title : ('Paper Draft: ' + q),
          sections: sections.map(function(s) {
            return {
              id: s.id,
              title: s.title,
              bullets: Array.isArray(s.bullets) ? s.bullets : [],
              content: [], // user-added snippets (claims / skill outputs)
              body: ''     // composed section text
            };
          }),
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        };
      }

      function renderDraft(draft) {
        var sectionOptions = (draft.sections || []).map(function(s) {
          return '<option value=\"' + s.id + '\">' + escapeHtml(s.title) + '</option>';
        }).join('');

        // Calculate statistics
        var totalSections = (draft.sections || []).length;
        var totalItems = 0;
        var totalComposed = 0;
        (draft.sections || []).forEach(function(s) {
          totalItems += (s.content || []).length;
          if (s.body && s.body.trim()) totalComposed++;
        });

        // Build section blocks with collapsible and truncation
        var sectionsHtml = (draft.sections || []).map(function(s, idx) {
          var bullets = s.bullets || [];
          var items = s.content || [];
          var hasBody = s.body && s.body.trim();
          
          // Bullets HTML (truncate to 5)
          var bulletsToShow = bullets.slice(0, 5);
          var bulletsHtml = bulletsToShow.map(function(b) { return '<li>' + escapeHtml(b) + '</li>'; }).join('');
          var bulletsMore = bullets.length > 5;
          
          // Items HTML (truncate to 3)
          var itemsToShow = items.slice(0, 3);
          var itemsHtml = itemsToShow.map(function(it) {
            return (
              '<li>' +
                '<span class=\"draft-pill\">' + escapeHtml(it.source || 'note') + '</span> ' +
                '<span class=\"draft-item-text\">' + escapeHtml(it.text) + '</span>' +
                '<button class=\"draft-item-del\" data-section=\"' + s.id + '\" data-text=\"' + encodeURIComponent(it.text) + '\">‚úï</button>' +
              '</li>'
            );
          }).join('');
          var itemsMore = items.length > 3;
          if (!itemsHtml && !itemsMore) itemsHtml = '<li class=\"draft-empty\">(No items yet)</li>';
          
          // Body preview (truncate to ~120px height)
          var bodyHtml = hasBody ? escapeHtml(s.body) : '<span class=\"draft-empty\">(No composed text yet)</span>';
          var bodyNeedsExpand = hasBody && s.body.length > 200;
          
          // Section stats
          var sectionStats = [];
          if (items.length > 0) sectionStats.push(items.length + ' item' + (items.length !== 1 ? 's' : ''));
          if (hasBody) sectionStats.push('composed');
          if (bullets.length > 0) sectionStats.push(bullets.length + ' bullet' + (bullets.length !== 1 ? 's' : ''));
          var statsText = sectionStats.length > 0 ? ' ¬∑ ' + sectionStats.join(', ') : '';
          
          return (
            '<div class=\"draft-section\" data-section-id=\"' + s.id + '\">' +
              '<div class=\"draft-section-head\">' +
                '<div style=\"flex: 1;\">' +
                  '<div class=\"draft-section-title\">' + escapeHtml(s.title) + '<span class=\"draft-section-stats\">' + statsText + '</span></div>' +
                '</div>' +
                '<span class=\"draft-section-toggle\">‚ñ∂</span>' +
              '</div>' +
              '<div class=\"draft-section-content\">' +
                (bullets.length > 0 ? (
                  '<div class=\"draft-subtitle\">Outline bullets</div>' +
                  '<ul class=\"draft-bullets\">' + bulletsHtml + '</ul>' +
                  (bulletsMore ? '<div class=\"draft-section-collapsible\" id=\"bullets-' + s.id + '\" style=\"display:none;\"><ul class=\"draft-bullets\">' + bullets.slice(5).map(function(b) { return '<li>' + escapeHtml(b) + '</li>'; }).join('') + '</ul></div><span class=\"draft-show-more\" data-toggle=\"bullets-' + s.id + '\">Show all ' + bullets.length + ' bullets</span>' : '')
                ) : '') +
                '<div class=\"draft-subtitle\">Draft items</div>' +
                '<ul class=\"draft-items\">' + itemsHtml + '</ul>' +
                (itemsMore ? '<div class=\"draft-section-collapsible\" id=\"items-' + s.id + '\" style=\"display:none;\"><ul class=\"draft-items\">' + items.slice(3).map(function(it) {
                  return '<li><span class=\"draft-pill\">' + escapeHtml(it.source || 'note') + '</span> <span class=\"draft-item-text\">' + escapeHtml(it.text) + '</span><button class=\"draft-item-del\" data-section=\"' + s.id + '\" data-text=\"' + encodeURIComponent(it.text) + '\">‚úï</button></li>';
                }).join('') + '</ul></div><span class=\"draft-show-more\" data-toggle=\"items-' + s.id + '\">Show all ' + items.length + ' items</span>' : '') +
                '<div class=\"draft-subtitle\" style=\"margin-top:0.75rem;\">Composed text</div>' +
                '<div class=\"draft-body-preview' + (bodyNeedsExpand ? '' : ' expanded') + '\" id=\"body-' + s.id + '\">' + bodyHtml + '</div>' +
                (bodyNeedsExpand ? '<span class=\"draft-show-more\" data-toggle=\"body-' + s.id + '\">Expand full text</span>' : '') +
                '<div style=\"margin-top:0.75rem; text-align:right;\"><button class=\"draft-compose-btn\" data-section=\"' + s.id + '\">Compose section text</button></div>' +
              '</div>' +
            '</div>'
          );
        }).join('');

        // Build references summary for sidebar (from draft items)
        var refs = {};
        (draft.sections || []).forEach(function(s) {
          (s.content || []).forEach(function(it) {
            if (it.refKey && it.refText && !refs[it.refKey]) {
              refs[it.refKey] = it.refText;
            }
          });
        });
        var refsKeys = Object.keys(refs);
        var refsHtml = '';
        if (refsKeys.length) {
          refsHtml = '<div class=\"draft-references\">' +
            '<div class=\"draft-subtitle\">References used in draft items</div>' +
            '<ul class=\"draft-history-list\">' +
              refsKeys.map(function(k) {
                return '<li class=\"draft-ref-item\">' + escapeHtml(refs[k]) + '</li>';
              }).join('') +
            '</ul>' +
          '</div>';
        } else {
          refsHtml = '<div class=\"draft-references\"><div class=\"draft-subtitle\">References used in draft items</div><div class=\"draft-empty\">(No references yet)</div></div>';
        }

        var histRaw = localStorage.getItem(draftHistoryKey());
        var hist = [];
        try { hist = histRaw ? JSON.parse(histRaw) : []; } catch (e) { hist = []; }
        var historyHtml = hist.slice(0, 5).map(function(h, idx) {
          return '<li><button class=\"draft-link\" data-hist=\"' + idx + '\">' + escapeHtml(h.at) + '</button></li>';
        }).join('');
        if (!historyHtml) historyHtml = '<li class=\"draft-empty\">(No history yet)</li>';

        skillsContent.innerHTML =
          '<div class=\"draft-wrap\">' +
            '<div class=\"draft-head\">' +
              '<div>' +
                '<div class=\"draft-title\">' + escapeHtml(draft.title) + '</div>' +
                '<div class=\"draft-meta\">Saved automatically. Query: <strong>' + escapeHtml(q) + '</strong></div>' +
              '</div>' +
              '<div class=\"draft-actions\">' +
                '<button class=\"skill-back-btn\" id=\"draft-regenerate\">Regenerate Outline</button>' +
                '<button class=\"skill-back-btn\" id=\"draft-export\">Export Markdown</button>' +
                '<button class=\"skill-back-btn\" id=\"draft-clear\">Clear Draft</button>' +
              '</div>' +
            '</div>' +

            '<div class=\"draft-stats\">' +
              '<div class=\"draft-stats-item\"><span class=\"draft-stats-number\">' + totalSections + '</span> sections</div>' +
              '<div class=\"draft-stats-item\"><span class=\"draft-stats-number\">' + totalItems + '</span> items</div>' +
              '<div class=\"draft-stats-item\"><span class=\"draft-stats-number\">' + totalComposed + '</span> composed</div>' +
            '</div>' +

            '<input type=\"text\" class=\"draft-search\" id=\"draft-search\" placeholder=\"Search sections, items...\" />' +

            '<div class=\"draft-add\">' +
              '<div class=\"draft-subtitle\">Add a snippet</div>' +
              '<textarea id=\"draft-snippet\" class=\"draft-textarea\" rows=\"3\" placeholder=\"Paste a claim or a sentence from skills output...\"></textarea>' +
              '<div class=\"draft-row\">' +
                '<label class=\"draft-label\"><input type=\"checkbox\" id=\"draft-auto\" checked> Auto place (AI)</label>' +
                '<select id=\"draft-section\" class=\"draft-select\">' + sectionOptions + '</select>' +
                '<button class=\"skills-toggle\" id=\"draft-add-btn\">Add</button>' +
              '</div>' +
              '<div class=\"draft-hint\">Tip: you can also click "Add to Draft" on any Key Claim.</div>' +
            '</div>' +

            '<div class=\"draft-sections\" id=\"draft-sections-container\">' + sectionsHtml + '</div>' +
            '<div class=\"draft-history\">' +
              '<div class=\"draft-subtitle\">Recent versions</div>' +
              '<ul class=\"draft-history-list\">' + historyHtml + '</ul>' +
            '</div>' +
            refsHtml +
          '</div>';

        // wire actions
        document.getElementById('draft-regenerate').addEventListener('click', async function() {
          if (!confirm('Regenerate the outline bullets? (Your added draft items will be kept)')) return;
          skillsContent.innerHTML = '<div class=\"skill-loading\">Regenerating outline...</div>';
          var outlineJson = await AIService.generateDraftOutline(q, matchedPapers);
          var current = loadDraft();
          if (!current) current = defaultDraftFromOutline(outlineJson);

          // merge: keep existing content per section id, replace bullets/titles from new outline
          var contentById = {};
          (current.sections || []).forEach(function(s) { contentById[s.id] = s.content || []; });

          current.title = (outlineJson && outlineJson.title) ? outlineJson.title : current.title;
          current.sections = (outlineJson.sections || []).map(function(s) {
            return {
              id: s.id,
              title: s.title,
              bullets: Array.isArray(s.bullets) ? s.bullets : [],
              content: contentById[s.id] || []
            };
          });
          saveDraft(current);
          renderDraft(loadDraft());
        });

        document.getElementById('draft-add-btn').addEventListener('click', async function() {
          var textEl = document.getElementById('draft-snippet');
          var text = (textEl && textEl.value || '').trim();
          if (!text) return;
          var auto = document.getElementById('draft-auto').checked;
          var sectionId = document.getElementById('draft-section').value;

          // Ensure we operate on the latest draft and create one if missing
          draft = loadDraft() || draft;
          if (!draft) {
            skillsContent.innerHTML = '<div class="skill-loading">Creating a draft outline...</div>';
            var outlineJson = await AIService.generateDraftOutline(q, matchedPapers);
            draft = defaultDraftFromOutline(outlineJson);
            saveDraft(draft);
          }

          // Duplicate check: same text already exists anywhere in draft
          var exists = false;
          (draft.sections || []).forEach(function(s) {
            (s.content || []).forEach(function(it) {
              if ((it.text || '').trim() === text) {
                exists = true;
              }
            });
          });
          if (exists) {
            if (!confirm('This snippet already exists in the draft. Add again?')) {
              return;
            }
          }

          if (auto) {
            try {
              sectionId = await AIService.classifySnippetToSection(q, text);
            } catch (e) {}
          }

          var source = draftPendingSource || (auto ? 'auto' : 'manual');

          // If textarea carries ref info (from claim), use it
          var refKey = (textEl && textEl.dataset.refKey) || null;
          var refText = (textEl && textEl.dataset.refText) || null;

          addToDraft(draft, sectionId, text, source, refKey, refText);

          draftPendingSource = 'manual';
          if (textEl) {
            textEl.value = '';
            textEl.dataset.refKey = '';
            textEl.dataset.refText = '';
          }
          renderDraft(loadDraft());
        });

        document.getElementById('draft-export').addEventListener('click', function() {
          var md = exportDraftMarkdown(loadDraft());
          if (!md || !md.trim()) {
            alert('No draft content to open in notebook.');
            return;
          }
          try {
            localStorage.setItem('thread_notebook_markdown', md);
            localStorage.setItem('thread_notebook_query', q || '');
          } catch (e) {}
          window.open('notebook.html', '_blank', 'noopener');
        });

        document.getElementById('draft-clear').addEventListener('click', function() {
          if (!confirm('Clear this draft?')) return;
          localStorage.removeItem(draftStorageKey());
          localStorage.removeItem(draftHistoryKey());
          loadSkills();
        });

        document.querySelectorAll('.draft-link').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(this.dataset.hist, 10);
            var histRaw2 = localStorage.getItem(draftHistoryKey());
            var hist2 = [];
            try { hist2 = histRaw2 ? JSON.parse(histRaw2) : []; } catch (e) { hist2 = []; }
            if (!hist2[idx] || !hist2[idx].draft) return;
            try {
              localStorage.setItem(draftStorageKey(), JSON.stringify(hist2[idx].draft));
              renderDraft(loadDraft());
            } catch (e) {}
          });
        });

        // Compose section text buttons
        document.querySelectorAll('.draft-compose-btn').forEach(function(btn) {
          btn.addEventListener('click', async function() {
            var secId = this.dataset.section;
            var current = loadDraft();
            if (!current || !current.sections) return;
            var sec = current.sections.find(function(s) { return s.id === secId; }) || current.sections[0];
            if (!sec) return;
            var bullets = sec.bullets || [];
            var items = sec.content || [];
            var existingBody = sec.body || '';

            skillsContent.innerHTML = '<div class="skill-loading">Composing section text...</div>';
            var composed = await AIService.composeSectionText(q, sec.title, bullets, items, existingBody);
            if (composed) {
              sec.body = existingBody ? (existingBody + '\n\n' + composed) : composed;
              saveDraft(current);
            }
            renderDraft(loadDraft());
          });
        });

        // Delete individual draft items
        document.querySelectorAll('.draft-item-del').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var secId = this.dataset.section;
            var text = '';
            try { text = decodeURIComponent(this.dataset.text || ''); } catch (e) { text = this.dataset.text || ''; }
            text = (text || '').trim();
            var current = loadDraft();
            if (!current || !current.sections || !text) return;
            var sec = current.sections.find(function(s) { return s.id === secId; }) || current.sections[0];
            if (!sec || !sec.content) return;
            sec.content = sec.content.filter(function(it) {
              return (it.text || '').trim() !== text;
            });
            saveDraft(current);
            renderDraft(loadDraft());
          });
        });

        // Section collapse/expand
        document.querySelectorAll('.draft-section-head').forEach(function(head) {
          head.addEventListener('click', function() {
            var section = this.closest('.draft-section');
            if (section) {
              section.classList.toggle('expanded');
            }
          });
        });

        // "Show more" buttons for truncation
        document.querySelectorAll('.draft-show-more').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var targetId = this.dataset.toggle;
            if (!targetId) return;
            var target = document.getElementById(targetId);
            if (!target) return;
            
            if (target.classList.contains('expanded')) {
              target.classList.remove('expanded');
              if (targetId.startsWith('body-')) {
                this.textContent = 'Expand full text';
              } else {
                this.textContent = this.textContent.replace('Hide', 'Show');
              }
            } else {
              target.classList.add('expanded');
              if (targetId.startsWith('body-')) {
                this.textContent = 'Collapse text';
              } else {
                this.textContent = this.textContent.replace('Show', 'Hide');
              }
            }
          });
        });

        // Search functionality
        var searchInput = document.getElementById('draft-search');
        if (searchInput) {
          searchInput.addEventListener('input', function() {
            var query = (this.value || '').toLowerCase().trim();
            var sections = document.querySelectorAll('.draft-section');
            
            if (!query) {
              sections.forEach(function(s) { s.style.display = ''; });
              return;
            }
            
            sections.forEach(function(section) {
              var title = (section.querySelector('.draft-section-title')?.textContent || '').toLowerCase();
              var items = section.querySelectorAll('.draft-item-text');
              var bullets = section.querySelectorAll('.draft-bullets li');
              var body = (section.querySelector('.draft-body-preview')?.textContent || '').toLowerCase();
              
              var matches = title.includes(query) || body.includes(query);
              if (!matches) {
                items.forEach(function(item) {
                  if (item.textContent.toLowerCase().includes(query)) matches = true;
                });
              }
              if (!matches) {
                bullets.forEach(function(bullet) {
                  if (bullet.textContent.toLowerCase().includes(query)) matches = true;
                });
              }
              
              section.style.display = matches ? '' : 'none';
              
              // Auto-expand matching sections
              if (matches) {
                section.classList.add('expanded');
              }
            });
          });
        }
      }

      function addToDraft(draft, sectionId, text, source, refKey, refText) {
        if (!draft || !draft.sections) return;
        var sec = draft.sections.find(function(s) { return s.id === sectionId; }) || draft.sections[0];
        if (!sec.content) sec.content = [];
        sec.content.push({
          text: text,
          source: source,
          at: new Date().toISOString(),
          refKey: refKey || null,
          refText: refText || null
        });
        saveDraft(draft);
      }

      function exportDraftMarkdown(draft) {
        if (!draft) return '';
        var out = [];
        // Title
        out.push('# ' + (draft.title || ('Paper Draft: ' + q)));
        out.push('');
        // Meta info
        out.push('> Query: ' + q);
        out.push('> Mode: ' + mode);
        out.push('> Updated: ' + (draft.updated_at || ''));
        out.push('');
        // Sections
        (draft.sections || []).forEach(function(s) {
          out.push('## ' + s.title);
          out.push('');
          if (s.bullets && s.bullets.length) {
            out.push('### Outline');
            (s.bullets || []).forEach(function(b) { out.push('- ' + b); });
            out.push('');
          }
          // Ê∑∑ÂêàÂ•ΩÁöÑÊ≠£ÊñáÁõ¥Êé•ÂÜôÂÖ•ÂØπÂ∫î section ‰∏≠
          if (s.body && s.body.trim()) {
            out.push(s.body.trim());
            out.push('');
          }
        });
        // References
        var refs = {};
        (draft.sections || []).forEach(function(s) {
          (s.content || []).forEach(function(it) {
            if (it.refKey && it.refText && !refs[it.refKey]) {
              refs[it.refKey] = it.refText;
            }
          });
        });
        var keys = Object.keys(refs);
        if (keys.length) {
          out.push('## References');
          out.push('');
          keys.forEach(function(k) {
            out.push('- ' + refs[k]);
          });
          out.push('');
        }
        // IMPORTANT: use real newlines, not literal "\n" sequences
        return out.join('\n');
      }

      // Helper: extract bullet sentences under a markdown header
      function extractBulletsByHeader(markdown, headerKeyword) {
        if (!markdown) return [];
        var lines = String(markdown).split(/\r?\n/);
        var inSection = false;
        var bullets = [];
        var headerKey = headerKeyword.toLowerCase();
        lines.forEach(function(line) {
          var trimmed = line.trim();
          if (trimmed.startsWith('#')) {
            inSection = trimmed.toLowerCase().indexOf(headerKey) !== -1;
            return;
          }
          if (!inSection) return;
          if (trimmed.startsWith('- ')) {
            bullets.push(trimmed.slice(2).trim());
          }
        });
        return bullets.filter(function(b) { return b.length > 0; });
      }

      // Helper: ensure a draft exists (create outline if needed)
      async function ensureDraftExists() {
        var draft = loadDraft();
        if (draft) return draft;
        skillsPanel.classList.add('active');
        skillsContent.innerHTML = '<div class="skill-loading">Creating a draft outline...</div>';
        var outlineJson = await AIService.generateDraftOutline(q, matchedPapers);
        draft = defaultDraftFromOutline(outlineJson);
        saveDraft(draft);
        return draft;
      }

      // Helper: stage a sentence into draft, optionally biasing to a section
      async function stageSentenceToDraft(sentence, source, preferredSectionKeyword) {
        sentence = (sentence || '').trim();
        if (!sentence) return;
        var draft = await ensureDraftExists();
        skillsPanel.classList.add('active');
        renderDraft(loadDraft());
        draftPendingSource = source || 'skill';

        // Try to select preferred section if provided
        if (preferredSectionKeyword && draft && Array.isArray(draft.sections)) {
          var key = preferredSectionKeyword.toLowerCase();
          var sec = draft.sections.find(function(s) {
            return s.title && s.title.toLowerCase().indexOf(key) !== -1;
          });
          if (sec && document.getElementById('draft-section')) {
            document.getElementById('draft-section').value = sec.id;
            var autoChk = document.getElementById('draft-auto');
            if (autoChk) autoChk.checked = false;
          }
        }

        var ta = document.getElementById('draft-snippet');
        if (ta) {
          ta.value = sentence;
          ta.focus();
        }
      }

      async function executeSkill(skillId) {
        if (!matchedPapers || matchedPapers.length === 0) {
          skillsContent.innerHTML = '<div class="skill-error">No papers available. Please search for papers first.<br><button class="skill-back-btn" id="skill-back-btn-error">Back to Skills</button></div>';
          document.getElementById('skill-back-btn-error').addEventListener('click', function() {
            loadSkills();
          });
          return;
        }
        
        skillsContent.innerHTML = '<div class="skill-loading">Generating...</div>';
        
        try {
          var result = '';
          if (skillId === 'draft') {
            // Create or open a draft (outline first), then allow incremental building.
            var existing = loadDraft();
            if (!existing) {
              skillsContent.innerHTML = '<div class="skill-loading">Creating a draft outline...</div>';
              var outlineJson = await AIService.generateDraftOutline(q, matchedPapers);
              var draft = defaultDraftFromOutline(outlineJson);
              saveDraft(draft);
              renderDraft(loadDraft());
              return;
            }
            renderDraft(existing);
            return;
          } else if (skillId === 'explain') {
            result = await AIService.explainConcepts(q, matchedPapers);
          } else if (skillId === 'compare') {
            if (matchedPapers.length < 2) {
              throw new Error('Need at least 2 papers to compare');
            }
            result = await AIService.comparePapers(matchedPapers.slice(0, 3));
          } else if (skillId === 'gaps') {
            result = await AIService.identifyResearchGaps(q, matchedPapers);
          } else if (skillId === 'trends') {
            result = await AIService.trackTrends(q, matchedPapers);
          } else {
            throw new Error('Unknown skill: ' + skillId);
          }

          if (!result || (typeof result === 'string' && !result.trim())) {
            throw new Error('Empty response from AI service');
          }

          // Student skills with special UI: explain / compare
          if (skillId === 'explain' || skillId === 'compare') {
            var rawText = String(result);
            var headerKey = skillId === 'explain'
              ? 'paper-ready sentences (intro'
              : 'paper-ready sentences (related work';
            var bullets = extractBulletsByHeader(rawText, headerKey);

            var escapedResult = escapeHtml(rawText).replace(/\n/g, '<br>');
            var bulletsHtml = '';
            if (bullets.length) {
              bulletsHtml =
                '<div class="draft-subtitle">' + (skillId === 'explain' ? 'Intro-ready sentences' : 'Related Work sentences') + '</div>' +
                '<ul class="draft-items">' +
                  bullets.map(function(sent, idx) {
                    return (
                      '<li>' +
                        '<span class="draft-item-text">' + escapeHtml(sent) + '</span>' +
                        '<button class="draft-item-del" data-role="add-to-draft" data-index="' + idx + '">+ Draft</button>' +
                      '</li>'
                    );
                  }).join('') +
                '</ul>';
            } else {
              bulletsHtml = '<div class="draft-empty">(No structured sentences found. You can still select text below and add manually.)</div>';
            }

            skillsContent.innerHTML =
              '<div class="skill-result">' +
                '<div class="draft-inline-actions">' +
                  '<button class="skills-toggle" id="add-selected-to-draft">Add selected text to Draft</button>' +
                  '<span class="draft-inline-hint">Select text in the output, then click.</span>' +
                '</div>' +
                '<div class="draft-add">' +
                  bulletsHtml +
                '</div>' +
                '<pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.6; margin-top: 1rem;">' +
                  escapedResult +
                '</pre>' +
                '<button class="skill-back-btn" id="skill-back-btn">Back to Skills</button>' +
              '</div>';

            // Wire back button
            var backBtn2 = document.getElementById('skill-back-btn');
            if (backBtn2) {
              backBtn2.addEventListener('click', function() {
                loadSkills();
              });
            }

            // Wire "Add selected text to Draft" (fallback manual selection)
            var addSelBtn2 = document.getElementById('add-selected-to-draft');
            if (addSelBtn2) {
              addSelBtn2.addEventListener('click', async function() {
                var selection = '';
                try { selection = (window.getSelection && window.getSelection().toString()) || ''; } catch (e) { selection = ''; }
                selection = (selection || '').trim();
                if (!selection) {
                  alert('Please select some text in the output first.');
                  return;
                }
                await stageSentenceToDraft(selection, 'skill', null);
              });
            }

            // Wire "+ Draft" buttons for structured sentences
            if (bullets.length) {
              var buttons = skillsContent.querySelectorAll('button[data-role="add-to-draft"]');
              buttons.forEach(function(btn) {
                btn.addEventListener('click', function() {
                  var idx = parseInt(this.dataset.index, 10);
                  if (isNaN(idx) || idx < 0 || idx >= bullets.length) return;
                  var preferred = (skillId === 'explain') ? 'introduction' : 'related';
                  stageSentenceToDraft(bullets[idx], skillId, preferred);
                });
              });
            }
          } else {
            // Default rendering for other skills
            var escapedResult2 = escapeHtml(result).replace(/\n/g, '<br>');
            skillsContent.innerHTML = '<div class="skill-result">' +
              '<div class="draft-inline-actions">' +
                '<button class="skills-toggle" id="add-selected-to-draft">Add selected text to Draft</button>' +
                '<span class="draft-inline-hint">Select text in the output, then click.</span>' +
              '</div>' +
              '<pre style="white-space: pre-wrap; font-family: inherit; line-height: 1.6;">' + 
              escapedResult2 + 
              '</pre>' +
              '<button class="skill-back-btn" id="skill-back-btn">Back to Skills</button>' +
              '</div>';
            
            // Back button
            var backBtn = document.getElementById('skill-back-btn');
            if (backBtn) {
              backBtn.addEventListener('click', function() {
                loadSkills();
              });
            }

            // Add selected snippet to draft (stage into Add a snippet box)
            var addSelBtn = document.getElementById('add-selected-to-draft');
            if (addSelBtn) {
              addSelBtn.addEventListener('click', async function() {
                var selection = '';
                try { selection = (window.getSelection && window.getSelection().toString()) || ''; } catch (e) { selection = ''; }
                selection = (selection || '').trim();
                if (!selection) {
                  alert('Please select some text in the output first.');
                  return;
                }
                await stageSentenceToDraft(selection, 'skill', null);
              });
            }
          }
        } catch (error) {
          console.error('Skill execution failed:', error);
          var errorMsg = error.message || 'Unknown error occurred';
          skillsContent.innerHTML = '<div class="skill-error">Error: ' + escapeHtml(errorMsg) + '<br><button class="skill-back-btn" id="skill-back-btn-error">Back to Skills</button></div>';
          var errorBtn = document.getElementById('skill-back-btn-error');
          if (errorBtn) {
            errorBtn.addEventListener('click', function() {
              loadSkills();
            });
          }
        }
      }

      // Form submission
      document.getElementById('results-search').addEventListener('submit', function(e) {
        e.preventDefault();
        var newQ = input.value.trim();
        if (!newQ) return;
        var newMode = searchMode.value;
        location.href = 'results.html?q=' + encodeURIComponent(newQ) + '&mode=' + newMode;
      });
    })();
  </script>
</body>
</html>
