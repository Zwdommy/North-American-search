<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Thread Notebook — Paper Draft</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Source+Serif+4:opsz,wght@8..60,600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/style.css">
</head>
<body class="page notebook-page">
  <header class="site-header notebook-header">
    <div class="wrap">
      <div class="notebook-header-left">
        <a href="index.html" class="logo">Thread<span>.</span></a>
        <div class="notebook-title-block">
          <div class="notebook-title" id="notebook-title">
            <span class="notebook-title-icon" aria-hidden="true">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                <rect x="5" y="3" width="14" height="18" rx="2"></rect>
                <line x1="9" y1="7" x2="15" y2="7"></line>
                <line x1="9" y1="11" x2="15" y2="11"></line>
                <line x1="9" y1="15" x2="13" y2="15"></line>
              </svg>
            </span>
            <span>Paper Notebook</span>
          </div>
          <div class="notebook-subtitle" id="notebook-subtitle">—</div>
        </div>
      </div>
      <div class="notebook-header-actions">
        <button id="notebook-export" class="notebook-btn">
          <span class="notebook-btn-icon" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <rect x="9" y="9" width="11" height="11" rx="2"></rect>
              <rect x="4" y="4" width="11" height="11" rx="2"></rect>
            </svg>
          </span>
          <span class="notebook-btn-label">Copy Markdown</span>
        </button>
        <button id="notebook-clear" class="notebook-btn notebook-btn-ghost">
          <span class="notebook-btn-icon" aria-hidden="true">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <polyline points="3 6 5 6 21 6"></polyline>
              <path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6"></path>
              <path d="M10 3h4a1 1 0 0 1 1 1v2H9V4a1 1 0 0 1 1-1z"></path>
            </svg>
          </span>
          <span class="notebook-btn-label">Clear</span>
        </button>
      </div>
    </div>
  </header>

  <main class="main notebook-main">
    <section class="notebook-shell">
      <div class="notebook-layout">
        <aside class="notebook-sidebar">
          <div class="notebook-sidebar-head">
            <div class="notebook-sidebar-title">
              <span class="notebook-sidebar-icon" aria-hidden="true">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M4 4h10l6 6v10H4z"></path>
                  <polyline points="14 4 14 10 20 10"></polyline>
                </svg>
              </span>
              <span>Sections</span>
            </div>
          </div>
          <ul id="notebook-sections" class="notebook-sections-list">
            <li class="notebook-section-empty">(No sections found)</li>
          </ul>
        </aside>

        <section class="notebook-editor-pane">
          <div class="notebook-editor-head">
            <div class="notebook-editor-label">Markdown draft</div>
            <div class="notebook-editor-head-right">
              <div class="notebook-editor-meta" id="notebook-length-meta">0 characters</div>
              <div class="notebook-editor-tabs">
                <button type="button" class="notebook-tab notebook-tab-active" data-mode="edit">Edit</button>
                <button type="button" class="notebook-tab" data-mode="preview">Preview</button>
              </div>
            </div>
          </div>
          <textarea id="notebook-editor" class="notebook-editor" spellcheck="false" placeholder="# Start writing your paper draft here..."></textarea>
          <div id="notebook-preview" class="notebook-preview" hidden></div>
        </section>
      </div>
    </section>
  </main>

  <script>
    (function () {
      var STORAGE_KEY = 'thread_notebook_markdown';
      var QUERY_KEY = 'thread_notebook_query';

      var editor = document.getElementById('notebook-editor');
      var titleEl = document.getElementById('notebook-title');
      var subtitleEl = document.getElementById('notebook-subtitle');
      var sectionsEl = document.getElementById('notebook-sections');
      var lengthMeta = document.getElementById('notebook-length-meta');
      var previewEl = document.getElementById('notebook-preview');
      var tabs = document.querySelectorAll('.notebook-tab');
      var currentMode = 'edit';

      function loadInitial() {
        var md = localStorage.getItem(STORAGE_KEY) || '';
        var q = localStorage.getItem(QUERY_KEY) || '';
        editor.value = md;
        if (q) {
          subtitleEl.textContent = 'Draft for: ' + q;
        } else {
          subtitleEl.textContent = 'Standalone notebook';
        }
        updateSections(md);
        updateLengthMeta(md);
        if (currentMode === 'preview') {
          renderPreview(md);
        }
      }

      function updateLengthMeta(text) {
        var len = (text || '').length;
        var words = text.trim() ? text.trim().split(/\s+/).length : 0;
        lengthMeta.textContent = len + ' characters · ' + words + ' words';
      }

      function updateSections(md) {
        var lines = (md || '').split(/\r?\n/);
        var sections = [];
        lines.forEach(function (line) {
          var trimmed = line.trim();
          if (/^#{1,2}\s+/.test(trimmed)) {
            sections.push(trimmed.replace(/^#{1,2}\s+/, '').trim());
          }
        });

        // Sidebar sections
        sectionsEl.innerHTML = '';
        if (!sections.length) {
          sectionsEl.innerHTML = '<li class="notebook-section-empty">(No sections found)</li>';
        } else {
          sections.forEach(function (title) {
            var li = document.createElement('li');
            li.className = 'notebook-section-item';
            li.textContent = title;
            li.addEventListener('click', function () {
              // simple jump: move caret to first occurrence
              var idx = editor.value.indexOf(title);
              if (idx >= 0) {
                editor.focus();
                editor.setSelectionRange(idx, idx + title.length);
              }
            });
            sectionsEl.appendChild(li);
          });
        }
      }

      function escapeHtml(text) {
        return (text || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;');
      }

      function renderInline(text) {
        var out = escapeHtml(text);
        out = out.replace(/`([^`]+)`/g, '<code>$1</code>');
        out = out.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
        out = out.replace(/\*([^*]+)\*/g, '<em>$1</em>');
        return out;
      }

      function renderPreview(md) {
        if (!previewEl) return;
        var lines = (md || '').split(/\r?\n/);
        var html = [];
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i];
          var trimmed = line.trim();
          if (!trimmed) {
            html.push('<p class="nb-line-empty"></p>');
            continue;
          }
          if (/^###\s+/.test(trimmed)) {
            html.push('<h3>' + renderInline(trimmed.replace(/^###\s+/, '')) + '</h3>');
          } else if (/^##\s+/.test(trimmed)) {
            html.push('<h2>' + renderInline(trimmed.replace(/^##\s+/, '')) + '</h2>');
          } else if (/^#\s+/.test(trimmed)) {
            html.push('<h1>' + renderInline(trimmed.replace(/^#\s+/, '')) + '</h1>');
          } else if (/^[-*]\s+/.test(trimmed)) {
            // simple bullet list: group consecutive list lines
            var items = [];
            while (i < lines.length && /^[-*]\s+/.test(lines[i].trim())) {
              items.push('<li>' + renderInline(lines[i].trim().replace(/^[-*]\s+/, '')) + '</li>');
              i++;
            }
            i--; // step back one because for-loop will ++
            html.push('<ul>' + items.join('') + '</ul>');
          } else {
            html.push('<p>' + renderInline(trimmed) + '</p>');
          }
        }
        previewEl.innerHTML = html.join('\n');
      }

      editor.addEventListener('input', function () {
        var val = editor.value || '';
        try {
          localStorage.setItem(STORAGE_KEY, val);
        } catch (e) {}
        updateSections(val);
        updateLengthMeta(val);
        if (currentMode === 'preview') {
          renderPreview(val);
        }
      });

      if (tabs && tabs.length) {
        tabs.forEach(function (tab) {
          tab.addEventListener('click', function () {
            var mode = this.dataset.mode || 'edit';
            if (mode === currentMode) return;
            currentMode = mode;
            tabs.forEach(function (t) { t.classList.remove('notebook-tab-active'); });
            this.classList.add('notebook-tab-active');
            if (mode === 'edit') {
              editor.hidden = false;
              previewEl.hidden = true;
              editor.focus();
            } else {
              renderPreview(editor.value || '');
              editor.hidden = true;
              previewEl.hidden = false;
            }
          });
        });
      }

      document.getElementById('notebook-export').addEventListener('click', function () {
        var text = editor.value || '';
        if (!text.trim()) return;
        try {
          navigator.clipboard.writeText(text);
          alert('Markdown copied to clipboard.');
        } catch (e) {
          alert('Copy failed. You can still select and copy manually.');
        }
      });

      document.getElementById('notebook-clear').addEventListener('click', function () {
        if (!confirm('Clear this notebook draft?')) return;
        editor.value = '';
        updateSections('');
        updateLengthMeta('');
        try {
          localStorage.removeItem(STORAGE_KEY);
        } catch (e) {}
        if (currentMode === 'preview') {
          renderPreview('');
        }
      });

      loadInitial();
    })();
  </script>
</body>
</html>

